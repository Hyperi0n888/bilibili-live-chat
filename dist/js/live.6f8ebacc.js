(function(){"use strict";var e={1489:function(e,n,t){var a=t(8764);window.Buffer=a.Buffer;var o=t(9963),i=t(6252),s=t(3577);function r(e,n,t,a,o,r){const l=(0,i.up)("danmaku-item"),u=(0,i.up)("live");return e.errMsg?((0,i.wg)(),(0,i.j4)(l,{key:0,type:"info",message:e.errMsg},null,8,["message"])):e.ready?((0,i.wg)(),(0,i.j4)(u,(0,s.vs)((0,i.dG)({key:1},e.props)),null,16)):(0,i.kq)("",!0)}var l=t(2262),u=t(8718),c=t.n(u),d=t(6604),m=t.n(d),f=t(7563);const p={room:"",anchor:"",cors:"false",face:"false",faceExpireDay:"",display:"bottom",stay:"",limit:"",giftComb:"",giftPin:"",delay:"",blockUID:"",debug:"",backgroundColor:"#FFFFFF",backgroundOpactiy:1};Object.freeze(p);const g=["room","anchor","faceExpireDay","stay","giftComb","limit","giftPin","delay"];Object.freeze(g);const v=new Set(g);Object.freeze(v);const h=e=>v.has(e),w={faceExpireDay:7};Object.freeze(w);const y=m()(p,((e,n)=>v.has(n)?Number:String));Object.freeze(y);const b={cors:[{value:"false",text:"关闭（所有跨域请求将依赖 codetabs，限制 5 请求/秒）"},{value:"true",text:"开启（请阅读右侧说明）"}],face:[{value:"false",text:"不显示"},{value:"gift",text:"仅对礼物显示，不需要额外调用 API"},{value:"true",text:"显示，通过 Bilibili API 获取（跨域）"},{value:"imjad",text:"显示，通过 HibiAPI 获取"}],display:[{value:"bottom",text:"自底部"},{value:"top",text:"从顶部"}]};Object.freeze(b);const k=e=>m()(c()({...p,...(0,f.parse)(e)},Object.keys(p)),((e,n)=>h(n)?e&&parseInt(e)||w[n]||0:n in b?b[n].some((({value:n})=>n===e))?e:p[n]:e||p[n]));let _=!0;const S=e=>_=e,D=e=>fetch(e,{referrer:"",referrerPolicy:"no-referrer",mode:"no-cors"}).then((e=>e.json())),j=e=>fetch(`https://api.codetabs.com/v1/proxy/?quest=${e}`).then((e=>e.json())),O=e=>_?D(e):j(e);var L=t(928),x=t.n(L),E=t(7204),T=t.n(E),F=t(3279),P=t.n(F),H=t(7247);const C=()=>Math.floor(Date.now()/864e5),M={method:"false",expireDay:7},I=e=>Object.assign(M,e),A=e=>{switch(M.method){case"imjad":return D(`https://api.obfs.dev/api/bilibili/v3/user_info?uid=${e}&size=1`).then((e=>{var n,t;return null===(n=e.data)||void 0===n||null===(t=n.card)||void 0===t?void 0:t.face}));default:return O(`https://api.bilibili.com/x/web-interface/card?mid=${e}`).then((e=>{var n,t;return null===(n=e.data)||void 0===n||null===(t=n.card)||void 0===t?void 0:t.face}))}},G=([e,n])=>{n||(n="member/noface.jpg");const t=x()(n.split(".")),a=`https://i${e}.hdslb.com/bfs/face/${n}`;return"gif"===t?[[a,0]]:[[`${a}_48x48.${t}`,2e3],[a,5e3]]},z=([,,e])=>!e||C()-e>=M.expireDay,$=new Map(Object.entries((0,H.M)("face",{})).filter((([,e])=>!z(e))).map((([e,n])=>[Number(e),n]))),N=P()((()=>(0,H.y)("face",T()(Array.from($)))),5e3,{maxWait:5e3}),R=(e,n)=>{var t;if(!n)return;const a=parseInt(null===(t=/\/\/i(\d+)\./.exec(n))||void 0===t?void 0:t[1])||0,o=x()(n.split("/")),i=o.includes("noface")?[0,null,C()]:[a,o,C()];return $.set(e,i),N(),i},B=async e=>{const n=$.get(e);if(n&&!z(n))return G(n);try{return G(R(e,await A(e)))}catch(t){console.error("[face API error]",t)}return G([0,null])},J=(0,i._)("input",{class:"form-control",cols:"30",rows:"3",placeholder:"发个弹幕呗~"},null,-1),U=(0,i._)("span",{class:"input-group-btn"},[(0,i._)("button",{class:"btn btn-primary",type:"button"},"biu~")],-1);function q(e,n,t,a,o,r){const l=(0,i.up)("danmaku-list"),u=(0,i.up)("input-group");return(0,i.wg)(),(0,i.iD)("div",{id:"live",style:(0,s.j5)({backgroundColor:a.props.backgroundColor})},[a.props.giftPin?((0,i.wg)(),(0,i.j4)(l,(0,i.dG)({key:0,ref:"giftPinList"},a.props,{"gift-show-face":a.giftShowFace,"is-gift-list":!0}),null,16,["gift-show-face"])):(0,i.kq)("",!0),(0,i.Wm)(l,(0,i.dG)({ref:"danmakuList"},a.props),null,16),(0,i.Wm)(u,null,{default:(0,i.w5)((()=>[J,U])),_:1})],4)}var Z=t(4171);const K={key:0,class:"danmaku-list-pinned",ref:"danmakuListRef"},W={class:"danmaku-list hidden"},Y={class:"danmaku-list absolute",ref:"giftListRef"},V={key:1,class:"danmaku-list",ref:"danmakuListRef"},X={key:0,class:"danmaku-list-placeholder"};function Q(e,n,t,a,o,s){const r=(0,i.up)("danmaku-item");return t.isGiftList?((0,i.wg)(),(0,i.iD)("div",K,[(0,i._)("div",W,[((0,i.wg)(!0),(0,i.iD)(i.HY,null,(0,i.Ko)(e.giftPin,(e=>((0,i.wg)(),(0,i.j4)(r,{key:e,"show-face":t.giftShowFace,type:"gift",uname:"某人",giftName:"礼物",num:e},null,8,["show-face","num"])))),128))]),(0,i._)("div",Y,[((0,i.wg)(!0),(0,i.iD)(i.HY,null,(0,i.Ko)(a.danmakuList,(e=>((0,i.wg)(),(0,i.j4)(r,(0,i.dG)({key:e.key},e.props,{hidden:e.hidden,ref_for:!0,ref:n=>e.el=n}),null,16,["hidden"])))),128))],512)],512)):((0,i.wg)(),(0,i.iD)("div",V,["bottom"===e.display?((0,i.wg)(),(0,i.iD)("div",X)):(0,i.kq)("",!0),((0,i.wg)(!0),(0,i.iD)(i.HY,null,(0,i.Ko)(a.danmakuList,(e=>((0,i.wg)(),(0,i.j4)(r,(0,i.dG)({key:e.key},e.props,{hidden:e.hidden,ref_for:!0,ref:n=>e.el=n}),null,16,["hidden"])))),128))],512))}var ee=t(2404),ne=t.n(ee),te=(t(7658),t(7632));const ae=(e,n)=>new Promise(((t,a)=>{let o=0;const i=new XMLHttpRequest,s=setTimeout((()=>{i.abort()}),1e4),r=n?setTimeout((()=>{0===o&&i.abort()}),n):null;i.open("GET",e,!0),i.onprogress=e=>{e.lengthComputable&&(o=e.loaded/e.total)},i.onload=()=>{clearTimeout(r),clearTimeout(s),t(e)},i.onerror=a,i.onabort=a,i.send()}));var oe=async e=>{for(const[n,t]of e){const e=await ae(n,t).catch((()=>{console.warn("Timeout",n)}));if(e)return e}return e[0][0]||""};const ie=["src"],se={key:1,class:"danmaku-content"},re={class:"danmaku-message"},le={key:2,class:"danmaku-content"},ue=(0,i._)("span",{class:"danmaku-message"},"感谢 ",-1),ce={class:"danmaku-author-name"},de=(0,i._)("span",{class:"danmaku-message"}," 赠送 ",-1),me={class:"danmaku-gift-name"},fe=(0,i._)("span",{class:"danmaku-message"}," × ",-1),pe={class:"danmaku-gift-num"},ge={key:3,class:"danmaku-content"},ve=(0,i._)("span",{class:"danmaku-message"},"感谢 ",-1),he={class:"danmaku-author-name"},we={class:"danmaku-message"},ye={key:4,class:"danmaku-content"},be={class:"danmaku-message"};function ke(e,n,t,a,o,r){return(0,i.wg)(),(0,i.iD)("div",{class:(0,s.C_)(["danmaku-item",{hidden:a.isHidden}])},[t.showFace?((0,i.wg)(),(0,i.iD)("img",{key:0,class:"danmaku-author-face",src:t.face},null,8,ie)):(0,i.kq)("",!0),"message"===t.type?((0,i.wg)(),(0,i.iD)("div",se,[(0,i._)("span",{class:(0,s.C_)(["danmaku-author-name with-colon",{anchor:t.isAnchor,owner:t.isOwner}])},(0,s.zw)(t.uname),3),(0,i._)("span",re,(0,s.zw)(t.message),1)])):"gift"===t.type?((0,i.wg)(),(0,i.iD)("div",le,[ue,(0,i._)("span",ce,(0,s.zw)(t.uname),1),de,(0,i._)("span",me,(0,s.zw)(t.giftName),1),fe,(0,i._)("span",pe,(0,s.zw)(t.num),1)])):"sc"===t.type?((0,i.wg)(),(0,i.iD)("div",ge,[ve,(0,i._)("span",he,(0,s.zw)(t.uname),1),(0,i._)("span",we," 的SC："+(0,s.zw)(t.message),1)])):"info"===t.type?((0,i.wg)(),(0,i.iD)("div",ye,[(0,i._)("span",be,(0,s.zw)(t.message),1)])):(0,i.kq)("",!0)],2)}var _e={props:{type:{type:String,default:"message"},showFace:Boolean,face:String,uid:Number,uname:String,message:String,isAnchor:Boolean,isOwner:Boolean,action:String,giftName:String,num:Number,stay:Number,hidden:Boolean},setup(e){const n=(0,l.iH)(!1),t=(0,l.iH)(!1);if(e.stay){const a=setTimeout((()=>{n.value=!0,"info"===e.type&&setTimeout((()=>t.value=!0),800)}),e.stay);(0,i.Jd)((()=>clearTimeout(a)))}const a=(0,i.Fl)((()=>e.hidden||n.value));return{...(0,l.BK)(e),isHidden:a,needRemoved:t}}},Se=t(3744);const De=(0,Se.Z)(_e,[["render",ke]]);var je=De;const Oe=new Map;var Le={components:{DanmakuItem:je},props:{...y,isGiftList:Boolean,giftShowFace:Boolean},setup(e){let n=!0;(0,i.Jd)((()=>n=!1));const t=(0,l.iH)([]),a=(0,l.iH)(null),o=(0,l.iH)(null);(0,i.bv)((()=>{const e=a.value.getBoundingClientRect().top-5,n=()=>{const n=t.value.findIndex((n=>{var t,a,o,i;const{top:s=e,height:r=0}=null!==(t=null===(a=n.el)||void 0===a||null===(o=a.$el)||void 0===o?void 0:o.getBoundingClientRect())&&void 0!==t?t:{};return s<e&&(n.hidden=!0),s+r>e&&!(null!==(i=n.el)&&void 0!==i&&i.needRemoved)}));n>0&&t.value.splice(0,n)},o=setInterval(n,100);(0,i.Jd)((()=>clearInterval(o)))}));const s=()=>{const n=(0,l.SU)(e.isGiftList?o:a);n&&(n.scrollTop=n.scrollHeight)};e.isGiftList||((0,i.bv)((()=>window.addEventListener("resize",s))),(0,i.Jd)((()=>window.removeEventListener("resize",s))));const r=[],u=()=>{let e=200;const{length:a}=r;a>0&&(e=Math.min(e,1e3/a),t.value.push(r.shift()),(0,i.Y3)(s)),n&&setTimeout(u,e)};u();const c=async n=>{if(n.showFace){const e=await B(n.uid);let t,[a]=e.find((([e])=>t=Oe.get(e)))||[""];a?!0!==t&&(a=await t):(t=oe(e),Oe.set(a,t),a=await t,Oe.set(a,!0)),n.face=a}n.stay=n.stay||("bottom"===e.display?e.stay:0),r.push({props:n,key:(0,te.Z)(),el:null,hidden:!1})},d=[];if(e.limit){const n=setInterval((()=>{let n=d.splice(0);n.length&&(n.length>e.limit&&(n=ne()(Object.keys(n),e.limit).sort().map((e=>n[e]))),n.forEach((e=>c(e))))}),1e3);(0,i.Jd)((()=>clearInterval(n)))}const m=e=>d.push(e);return{...(0,l.BK)(e),danmakuList:t,danmakuListRef:a,giftListRef:o,addDanmaku:c,addSpeedLimitDanmaku:m}}};const xe=(0,Se.Z)(Le,[["render",Q]]);var Ee=xe,Te=t(4634),Fe={components:{DanmakuList:Ee,InputGroup:Te.Z},props:y,setup(e){const n=(0,l.iH)(null),t=(0,l.iH)(null),a=new Map,o=(0,i.Fl)((()=>!["false","gift"].includes(e.face))),s=(0,i.Fl)((()=>new Set(e.blockUID.split("|").map((e=>e.trim()))))),r=e=>s.value.has(String(e)),u=n=>{t.value.addDanmaku({type:"info",message:n,stay:e.stay||5e3})},c=n=>{e.limit?t.value.addSpeedLimitDanmaku(n):t.value.addDanmaku(n)};return(0,i.bv)((()=>{console.log("正在连接直播弹幕服务器");const s=new Z.KeepLiveWS(e.room);(0,i.Jd)((()=>s.close())),s.on("open",(()=>{console.log("已连接直播弹幕服务器"),u("已连接直播弹幕服务器")})),s.on("live",(()=>{console.log("已连接直播间",e.room),u(`已连接直播间 ${e.room}`)})),s.on("close",(()=>console.log("已断开与直播弹幕服务器的连接"))),s.on("heartbeat",(e=>console.log("当前人气值",e)));const l=e.giftPin?n:t;s.on("SEND_GIFT",(({data:{uid:n,uname:t,action:o,giftName:i,num:s,face:u}})=>{if(r(n))console.log(`屏蔽了来自[${t}]的礼物：${i}*${s}`);else if(R(n,u),e.giftComb){const r=`${n}-${i}`,u=a.get(r);u?a.set(r,{...u,num:u.num+s}):(a.set(r,{type:"gift",showFace:"false"!==e.face,uid:n,uname:t,action:o,giftName:i,num:s}),setTimeout((()=>{l.value.addDanmaku(a.get(r)),a.delete(r)}),e.giftComb))}else l.value.addDanmaku({type:"gift",showFace:"false"!==e.face,uid:n,uname:t,action:o,giftName:i,num:s})})),s.on("DANMU_MSG",(({info:[,n,[t,a,i]]})=>{if(r(t))return void console.log(`屏蔽了来自[${a}]的弹幕：${n}`);const s={type:"message",showFace:o.value,uid:t,uname:a,message:n,isAnchor:t===e.anchor,isOwner:!!i};e.delay>0?setTimeout((()=>c(s)),1e3*e.delay):c(s)})),s.on("SUPER_CHAT_MESSAGE",(n=>{console.log("SUPER_CHAT_MESSAGE",n);const{data:{uid:t,user_info:{uname:a},message:o}}=n;l.value.addDanmaku({type:"sc",showFace:"false"!==e.face,uid:t,uname:a,message:o})})),window.giftList=l,s.on("SUPER_CHAT_MESSAGE_JPN",(e=>console.log("SUPER_CHAT_MESSAGE_JPN",e))),s.on("USER_TOAST_MSG",(n=>{const{data:{uid:t,username:a,role_name:o,num:i}}=n;l.value.addDanmaku({type:"gift",showFace:"false"!==e.face,uid:t,uname:a,giftName:o,num:i})}))})),{props:e,giftShowFace:o,giftPinList:n,danmakuList:t}}};const Pe=(0,Se.Z)(Fe,[["render",q]]);var He=Pe,Ce=(0,i.aZ)({components:{Live:He,DanmakuItem:je},setup(){const e=()=>window.location.reload();window.addEventListener("hashchange",e),(0,i.Jd)((()=>window.removeEventListener("hashchange",e)));const n=(0,l.qj)(k(window.location.hash)),t="true"===n.cors;S(t),I({method:n.face,expireDay:n.faceExpireDay});const a=(0,l.iH)(!1),o=(0,l.iH)("");return n.anchor?a.value=!0:O(`https://api.live.bilibili.com/room/v1/Room/room_init?id=${n.room}`).then((({code:e,msg:t,data:{room_id:i,uid:s}})=>{0===e?(n.room=parseInt(i),n.anchor=parseInt(s),a.value=!0):o.value=t})).catch((()=>{o.value="获取房间信息失败",t&&(o.value+="，请检查是否正确禁用了浏览器的 web security 以允许直接跨域")})),n.debug&&import("https://fastly.jsdelivr.net/npm/vconsole/dist/vconsole.min.js").then((()=>{new window.VConsole})),{props:n,ready:a,errMsg:o}}});const Me=(0,Se.Z)(Ce,[["render",r]]);var Ie=Me;(0,o.ri)(Ie).mount("#app")}},n={};function t(a){var o=n[a];if(void 0!==o)return o.exports;var i=n[a]={id:a,loaded:!1,exports:{}};return e[a].call(i.exports,i,i.exports,t),i.loaded=!0,i.exports}t.m=e,function(){var e=[];t.O=function(n,a,o,i){if(!a){var s=1/0;for(c=0;c<e.length;c++){a=e[c][0],o=e[c][1],i=e[c][2];for(var r=!0,l=0;l<a.length;l++)(!1&i||s>=i)&&Object.keys(t.O).every((function(e){return t.O[e](a[l])}))?a.splice(l--,1):(r=!1,i<s&&(s=i));if(r){e.splice(c--,1);var u=o();void 0!==u&&(n=u)}}return n}i=i||0;for(var c=e.length;c>0&&e[c-1][2]>i;c--)e[c]=e[c-1];e[c]=[a,o,i]}}(),function(){t.n=function(e){var n=e&&e.__esModule?function(){return e["default"]}:function(){return e};return t.d(n,{a:n}),n}}(),function(){t.d=function(e,n){for(var a in n)t.o(n,a)&&!t.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:n[a]})}}(),function(){t.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()}(),function(){t.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)}}(),function(){t.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}}(),function(){t.nmd=function(e){return e.paths=[],e.children||(e.children=[]),e}}(),function(){var e={576:0};t.O.j=function(n){return 0===e[n]};var n=function(n,a){var o,i,s=a[0],r=a[1],l=a[2],u=0;if(s.some((function(n){return 0!==e[n]}))){for(o in r)t.o(r,o)&&(t.m[o]=r[o]);if(l)var c=l(t)}for(n&&n(a);u<s.length;u++)i=s[u],t.o(e,i)&&e[i]&&e[i][0](),e[i]=0;return t.O(c)},a=self["webpackChunkbilibili_live_chat"]=self["webpackChunkbilibili_live_chat"]||[];a.forEach(n.bind(null,0)),a.push=n.bind(null,a.push.bind(a))}();var a=t.O(void 0,[64,639],(function(){return t(1489)}));a=t.O(a)})();